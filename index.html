<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Bucin Gesture Final üíï</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- TensorFlow -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>

<style>
body {
  margin: 0;
  height: 100vh;
  background: linear-gradient(135deg, #ff4d6d, #ff8fab, #ffc2d1);
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: system-ui, sans-serif;
  color: white;
  text-align: center;
  overflow: hidden;
}

#content {
  font-size: 2.2em;
  padding: 25px;
  max-width: 90%;
  opacity: 0;
  transition: opacity 0.8s ease;
}

.show {
  opacity: 1;
}

#photo {
  position: absolute;
  max-width: 75%;
  border-radius: 20px;
  box-shadow: 0 0 30px rgba(255,255,255,0.6);
  opacity: 0;
  transition: opacity 0.8s ease;
}

video {
  position: fixed;
  top: -1000px;
  left: -1000px;
  width: 1px;
  height: 1px;
  opacity: 0;
}
</style>
</head>

<body>

<div id="content" class="show">‚ù§Ô∏è</div>
<img id="photo" src="" alt="">
<video id="video" autoplay muted playsinline></video>

<script>
/* ================== ELEMENT ================== */
const content = document.getElementById("content");
const video = document.getElementById("video");
const photo = document.getElementById("photo");

/* ================== SLIDES ================== */
const slides = [
  "Hai Sayangku ü•∞",
  "Aku Sayang Kamu üòò",
  "Kamu adalah Rumah bagiku üè°",
  "Aku Berharap Kita Bisa Terus Bersama Sampai Kapanpun ü´∂üèªü§ó",
  "Terimakasih Sayang Udah Mau Nerima Aku Dengan Segala Kekuranganku.. ü•∞"
];

let slideIndex = -1;
let model;
let photoMode = false;

/* ================== STABILIZER ================== */
let lastGesture = "";
let stableCount = 0;

/* ================== IDLE ================== */
let lastActiveTime = Date.now();
const IDLE_TIME = 2500;

/* ================== UI ================== */
function showSlide(text) {
  content.classList.remove("show");
  setTimeout(() => {
    content.innerText = text;
    content.classList.add("show");
  }, 200);
}

function nextSlide() {
  slideIndex++;
  if (slideIndex >= slides.length) slideIndex = slides.length - 1;
  showSlide(slides[slideIndex]);
}

function resetToHeart() {
  slideIndex = -1;
  photoMode = false;
  photo.style.opacity = 0;
  content.innerText = "‚ù§Ô∏è";
  content.classList.add("show");
}

/* ================== PHOTO ================== */
function showPhoto() {
  if (photoMode) return;
  photoMode = true;
  content.classList.remove("show");
  photo.src = ""; // üëâ isi foto kamu nanti
  photo.style.opacity = 1;
}

function hidePhoto() {
  photoMode = false;
  photo.style.opacity = 0;
  if (slideIndex >= 0) showSlide(slides[slideIndex]);
}

/* ================== GESTURE ================== */
function fingerUp(tip, pip) {
  return tip[1] < pip[1] - 10;
}

function commitGesture(name) {
  lastActiveTime = Date.now();

  if (name === lastGesture) stableCount++;
  else {
    lastGesture = name;
    stableCount = 0;
  }

  if (stableCount === 6) handleGesture(name);
}

function handleGesture(gesture) {

  if (photoMode && gesture === "pinch") {
    hidePhoto();
    return;
  }

  if (slideIndex === -1 && gesture === "index") nextSlide();
  else if (slideIndex === 0 && gesture === "v") nextSlide();
  else if (slideIndex === 1 && gesture === "rock") nextSlide();
  else if (slideIndex === 2 && gesture === "pinch") nextSlide();
  else if (slideIndex === 3 && gesture === "palm") nextSlide();
}

/* ================== CAMERA ================== */
async function setupCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }
  });
  video.srcObject = stream;
  await video.play();
}

/* ================== DETECT ================== */
async function detect() {
  const hands = await model.estimateHands(video);

  if (hands.length === 2) {
    let victory = 0;

    for (const h of hands) {
      const lm = h.landmarks;
      const index = fingerUp(lm[8], lm[6]);
      const middle = fingerUp(lm[12], lm[10]);
      const ring = fingerUp(lm[16], lm[14]);
      const pinky = fingerUp(lm[20], lm[18]);

      if (index && middle && !ring && !pinky) victory++;
    }

    if (victory === 2) showPhoto();
  }

  if (hands.length === 1) {
    const lm = hands[0].landmarks;

    const index = fingerUp(lm[8], lm[6]);
    const middle = fingerUp(lm[12], lm[10]);
    const ring = fingerUp(lm[16], lm[14]);
    const pinky = fingerUp(lm[20], lm[18]);

    const pinch = Math.hypot(
      lm[4][0] - lm[8][0],
      lm[4][1] - lm[8][1]
    ) < 35;

    if (pinch) commitGesture("pinch");
    else if (index && middle && !ring && !pinky) commitGesture("v");
    else if (index && pinky && !middle && !ring) commitGesture("rock");
    else if (index && !middle && !ring && !pinky) commitGesture("index");
    else if (index && middle && ring && pinky) commitGesture("palm");
  }

  if (Date.now() - lastActiveTime > IDLE_TIME) {
    if (slideIndex !== -1 || photoMode) resetToHeart();
  }

  requestAnimationFrame(detect);
}

/* ================== START ================== */
(async () => {
  await setupCamera();
  model = await handpose.load();
  detect();
})();
</script>

</body>
</html>
