<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Bucin Particle Only</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>

<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  background:black;
  overflow:hidden;
}

/* Canvas */
canvas{
  position:absolute;
  inset:0;
}

/* FOTO â€“ TENGAH */
#photo{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) scale(.6);
  max-width:70%;
  border-radius:20px;
  opacity:0;
  filter:blur(14px);
  transition:
    opacity 1s ease,
    transform 1s ease,
    filter 1s ease;
  box-shadow:0 0 80px rgba(0,150,255,.7);
}

video{display:none}
</style>
</head>

<body>

<canvas id="c"></canvas>
<img id="photo" src="foto/IMG-20251103-WA0038.jpg">
<video id="video" autoplay playsinline></video>

<script>
/* ===== TEXT SLIDES ===== */
const slides=[
 "Hai Sayangku ðŸ¥°",
 "Aku Sayang Kamu ðŸ˜˜",
 "Kamu adalah Rumah bagiku ðŸ¡",
 "Aku Berharap Kita Bisa Terus Bersama Sampai Kapanpun ðŸ«¶ðŸ»ðŸ¤—",
 "Terimakasih Sayang Udah Mau Nerima Aku Dengan Segala Kekuranganku.. ðŸ¥°"
];

/* ===== CANVAS ===== */
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width=innerWidth;
  canvas.height=innerHeight;
}
resize();
addEventListener("resize",resize);

let particles=[];

/* ===== MULTILINE TEXT â†’ PARTICLES ===== */
function wrapText(text,maxWidth){
  const words=text.split(" ");
  const lines=[];
  let line="";

  for(const w of words){
    const test=line+w+" ";
    if(ctx.measureText(test).width>maxWidth && line){
      lines.push(line.trim());
      line=w+" ";
    }else{
      line=test;
    }
  }
  lines.push(line.trim());
  return lines;
}

function drawParticles(text){
  particles=[];
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const fontSize=Math.min(canvas.width/12,canvas.height/8);
  ctx.font=`bold ${fontSize}px system-ui`;
  ctx.textAlign="center";
  ctx.fillStyle="white";

  const maxWidth=canvas.width*0.8;
  const lines=wrapText(text,maxWidth);

  const startY=canvas.height/2-(lines.length-1)*fontSize*0.6;

  lines.forEach((line,i)=>{
    ctx.fillText(
      line,
      canvas.width/2,
      startY+i*fontSize*1.2
    );
  });

  const data=ctx.getImageData(0,0,canvas.width,canvas.height).data;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let y=0;y<canvas.height;y+=4){
    for(let x=0;x<canvas.width;x+=4){
      const i=(y*canvas.width+x)*4;
      if(data[i+3]>120){
        particles.push({
          x:Math.random()*canvas.width,
          y:Math.random()*canvas.height,
          tx:x,
          ty:y,
          a:0
        });
      }
    }
  }
}

function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  particles.forEach(p=>{
    p.x+=(p.tx-p.x)*0.06;
    p.y+=(p.ty-p.y)*0.06;
    p.a=Math.min(p.a+.02,1);
    ctx.fillStyle=`rgba(0,150,255,${p.a})`;
    ctx.fillRect(p.x,p.y,1.2,1.2);
  });
  if(particles.length)requestAnimationFrame(animate);
}

function clearAll(){
  particles=[];
  ctx.clearRect(0,0,canvas.width,canvas.height);
  hidePhoto();
}

/* ===== PHOTO ===== */
const photo=document.getElementById("photo");
function showPhoto(){
  photo.style.opacity=1;
  photo.style.transform="translate(-50%,-50%) scale(1)";
  photo.style.filter="blur(0)";
}
function hidePhoto(){
  photo.style.opacity=0;
  photo.style.transform="translate(-50%,-50%) scale(.6)";
  photo.style.filter="blur(14px)";
}

/* ===== CAMERA ===== */
const video=document.getElementById("video");
async function cam(){
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  video.srcObject=s;
  return new Promise(r=>video.onloadedmetadata=r);
}

/* ===== HAND DETECTION ===== */
let model,last="";
function up(t,p){return t[1]<p[1];}

async function detect(){
  const h=await model.estimateHands(video);

  if(!h.length){
    clearAll();
    last="";
    return requestAnimationFrame(detect);
  }

  const lm=h[0].landmarks;
  const idx=up(lm[8],lm[6]);
  const mid=up(lm[12],lm[10]);
  const ring=up(lm[16],lm[14]);
  const pink=up(lm[20],lm[18]);

  // â˜ï¸
  if(idx&&!mid&&!ring&&!pink&&last!=="1"){
    clearAll(); drawParticles(slides[0]); animate(); last="1";
  }
  // âœŒï¸
  else if(idx&&mid&&!ring&&!pink&&last!=="2"){
    clearAll(); drawParticles(slides[1]); animate(); last="2";
  }
  // ðŸ¤Ÿ
  else if(idx&&!mid&&!ring&&pink&&last!=="3"){
    clearAll(); drawParticles(slides[2]); animate(); last="3";
  }
  // âœ‹
  else if(idx&&mid&&ring&&pink&&last!=="4"){
    clearAll(); drawParticles(slides[3]); animate(); last="4";
  }
  // âœŠ
  else if(!idx&&!mid&&!ring&&!pink&&last!=="5"){
    clearAll(); drawParticles(slides[4]); animate(); last="5";
  }

  /* âœŒï¸âœŒï¸ DUA TANGAN VICTORY â†’ FOTO */
  let victoryCount = 0;

for(const hand of h){
  const lm = hand.landmarks;

  const index = up(lm[8], lm[6]);
  const middle = up(lm[12], lm[10]);
  const ring = up(lm[16], lm[14]);

  // Victory = telunjuk + tengah naik
  if(index && middle && !ring){
    victoryCount++;
  }
}

if(victoryCount >= 2){
  showPhoto();
}else{
  hidePhoto();
}

  requestAnimationFrame(detect);
}

/* ===== START ===== */
(async()=>{
  await cam();
  model=await handpose.load();
  detect();
})();
</script>

</body>
</html>
