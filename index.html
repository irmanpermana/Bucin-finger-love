<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Cinta Kita ðŸ’™</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- TensorFlow -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  overflow:hidden;
  font-family:system-ui;
}

/* Canvas partikel */
canvas{
  position:fixed;
  inset:0;
}

/* Foto */
#photo{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) scale(.6);
  max-width:70%;
  border-radius:20px;
  opacity:0;
  filter:blur(14px);
  transition:1s ease;
  box-shadow:0 0 80px rgba(0,150,255,.6);
}

/* Kamera disembunyikan */
video{
  position:fixed;
  width:1px;
  height:1px;
  opacity:0;
}
</style>
</head>

<body>

<canvas id="c"></canvas>
<img id="photo" src="foto/IMG-20251103-WA0038.jpg">
<video id="video" autoplay muted playsinline></video>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const video = document.getElementById("video");
const photo = document.getElementById("photo");

canvas.width = innerWidth;
canvas.height = innerHeight;
addEventListener("resize",()=>{
  canvas.width = innerWidth;
  canvas.height = innerHeight;
});

let model;
let particles=[];
let currentSlide=-1;

const slides=[
  "Hai Sayangku ðŸ¥°",
  "Aku Sayang Kamu ðŸ˜˜",
  "Kamu adalah Rumah bagiku ðŸ¡",
  "Aku berharap kita bisa terus bersama sampai kapanpun ðŸ«¶ðŸ»ðŸ¤—",
  "Terimakasih sayang sudah menerima aku dengan segala kekuranganku ðŸ¥°"
];

function clearAll(){
  particles=[];
  currentSlide=-1;
  hidePhoto();
}

function drawParticles(text){
  particles=[];
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const maxWidth = canvas.width*0.8;
  let fontSize=72;

  do{
    ctx.font=`bold ${fontSize}px system-ui`;
    fontSize-=2;
  }while(ctx.measureText(text).width>maxWidth);

  ctx.fillStyle="#0af";
  ctx.textAlign="center";
  ctx.textBaseline="middle";

  const words=text.split(" ");
  let lines=[],line="";

  for(let w of words){
    let test=line+w+" ";
    if(ctx.measureText(test).width>maxWidth){
      lines.push(line);
      line=w+" ";
    }else line=test;
  }
  lines.push(line);

  lines.forEach((l,i)=>{
    ctx.fillText(l,canvas.width/2,
      canvas.height/2 + i*fontSize*1.2 - (lines.length-1)*fontSize/2);
  });

  const img=ctx.getImageData(0,0,canvas.width,canvas.height);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let y=0;y<img.height;y+=4){
    for(let x=0;x<img.width;x+=4){
      if(img.data[(y*img.width+x)*4+3]>0){
        particles.push({
          x:Math.random()*canvas.width,
          y:Math.random()*canvas.height,
          tx:x,
          ty:y
        });
      }
    }
  }
}

function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  particles.forEach(p=>{
    p.x+=(p.tx-p.x)*0.08;
    p.y+=(p.ty-p.y)*0.08;
    ctx.fillStyle="#0af";
    ctx.fillRect(p.x,p.y,1.5,1.5);
  });
  requestAnimationFrame(animate);
}
animate();

/* FOTO */
function showPhoto(){
  photo.style.opacity=1;
  photo.style.transform="translate(-50%,-50%) scale(1)";
  photo.style.filter="blur(0)";
}
function hidePhoto(){
  photo.style.opacity=0;
  photo.style.transform="translate(-50%,-50%) scale(.6)";
  photo.style.filter="blur(14px)";
}

/* CAMERA */
async function setupCamera(){
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  video.srcObject=s;
  return new Promise(r=>video.onloadedmetadata=r);
}

/* UTIL */
function up(t,p){ return t[1]<p[1]; }
function isPinch(lm){
  return Math.hypot(lm[4][0]-lm[8][0], lm[4][1]-lm[8][1])<40;
}

/* DETECT */
async function detect(){
  const h=await model.estimateHands(video);

  if(!h.length){ clearAll(); requestAnimationFrame(detect); return; }

  const lm=h[0].landmarks;
  const idx=up(lm[8],lm[6]);
  const mid=up(lm[12],lm[10]);
  const ring=up(lm[16],lm[14]);
  const pink=up(lm[20],lm[18]);

  // Slide gestures
  if(idx&&!mid&&!ring&&!pink && currentSlide!==0){
    drawParticles(slides[0]); currentSlide=0;
  }
  else if(idx&&mid&&!ring&&!pink && currentSlide!==1){
    drawParticles(slides[1]); currentSlide=1;
  }
  else if(idx&&mid&&ring&&!pink && currentSlide!==2){
    drawParticles(slides[2]); currentSlide=2;
  }
  else if(idx&&mid&&ring&&pink && currentSlide!==3){
    drawParticles(slides[3]); currentSlide=3;
  }
  else if(!idx&&!mid&&!ring&&!pink && currentSlide!==4){
    drawParticles(slides[4]); currentSlide=4;
  }

  // PINCH FOTO
  let pinch=false;
  for(const hand of h){
    if(isPinch(hand.landmarks)){ pinch=true; break; }
  }
  pinch?showPhoto():hidePhoto();

  requestAnimationFrame(detect);
}

(async()=>{
  await setupCamera();
  model=await handpose.load();
  detect();
})();
</script>

</body>
</html>
