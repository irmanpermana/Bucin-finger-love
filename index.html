<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Cinta Kita ðŸ’™</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>

<style>
html,body{margin:0;padding:0;background:#000;overflow:hidden;}
canvas{position:fixed;inset:0;}
video{position:fixed;width:1px;height:1px;opacity:0;}
#photo{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%) scale(.6);
  max-width:70%;
  border-radius:20px;
  opacity:0;
  filter:blur(14px);
  transition:.5s ease;
  box-shadow:0 0 80px rgba(0,150,255,.6);
}
</style>
</head>

<body>

<canvas id="c"></canvas>
<img id="photo" src="foto/IMG-20251103-WA0038.jpg">
<video id="video" autoplay muted playsinline></video>
<audio id="bgm" src="musik/Virgoun_Last_Child_-_Surat_Cinta_Untuk_Starla_(mp3.pm).mp3" loop autoplay></audio>

<script>
/* ===== BASIC ===== */
const c = document.getElementById("c");
const ctx = c.getContext("2d");
const video = document.getElementById("video");
const photo = document.getElementById("photo");
const bgm = document.getElementById("bgm");

c.width = innerWidth;
c.height = innerHeight;
addEventListener("resize",()=>{c.width=innerWidth;c.height=innerHeight;});

let model;
let particles = [];
let currentSlide = -1;
let mode = "idle";

let lastGesture = "";
let gestureFrames = 0;
let lastSwitch = 0;

const HOLD = 8;
const COOLDOWN = 600;

/* ===== SLIDES ===== */
const slides = [
  "Hai Sayangku ðŸ¥°",
  "Aku Sayang Kamu ðŸ˜˜",
  "Kamu adalah Rumah bagiku ðŸ¡",
  "Aku berharap kita bisa terus bersama sampai kapanpun ðŸ«¶ðŸ»ðŸ¤—",
  "Terimakasih sayang sudah menerima aku dengan segala kekuranganku ðŸ¥°"
];

/* ===== PARTICLES ===== */
function drawParticles(text){
  particles=[];
  ctx.clearRect(0,0,c.width,c.height);

  let size=60, lines=[];
  while(size>18){
    ctx.font=`bold ${size}px system-ui`;
    lines=[]; let line="";
    for(const w of text.split(" ")){
      const t=line+w+" ";
      if(ctx.measureText(t).width>c.width*0.8){
        lines.push(line); line=w+" ";
      } else line=t;
    }
    lines.push(line);
    if(lines.length*size*1.3<c.height*0.6) break;
    size-=2;
  }

  ctx.font=`bold ${size}px system-ui`;
  ctx.fillStyle="#0af";
  ctx.textAlign="center";
  ctx.textBaseline="middle";

  lines.forEach((l,i)=>{
    ctx.fillText(
      l.trim(),
      c.width/2,
      c.height/2 + i*size*1.3 - (lines.length-1)*size*0.65
    );
  });

  const img = ctx.getImageData(0,0,c.width,c.height);
  ctx.clearRect(0,0,c.width,c.height);

  for(let y=0;y<img.height;y+=6){
    for(let x=0;x<img.width;x+=6){
      if(img.data[(y*img.width+x)*4+3]>0){
        particles.push({
          x:Math.random()*c.width,
          y:Math.random()*c.height,
          tx:x,
          ty:y
        });
      }
    }
  }
}

function animate(){
  ctx.clearRect(0,0,c.width,c.height);
  for(const p of particles){
    p.x += (p.tx - p.x) * 0.08;
    p.y += (p.ty - p.y) * 0.08;
    ctx.fillRect(p.x,p.y,1.5,1.5);
  }
  requestAnimationFrame(animate);
}
animate();

/* ===== PHOTO ===== */
const showPhoto=()=>{
  photo.style.opacity=1;
  photo.style.transform="translate(-50%,-50%) scale(1)";
  photo.style.filter="blur(0)";
};
const hidePhoto=()=>{
  photo.style.opacity=0;
  photo.style.transform="translate(-50%,-50%) scale(.6)";
  photo.style.filter="blur(14px)";
};

/* ===== CAMERA ===== */
async function setupCamera(){
  const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  video.srcObject = s;
  return new Promise(r=>video.onloadedmetadata=r);
}

/* ===== UTILS ===== */
const up=(t,p)=>t[1]<p[1];
const dist=(a,b)=>Math.hypot(a[0]-b[0],a[1]-b[1]);

/* ===== DETECT ===== */
async function detect(){
  const hands = await model.estimateHands(video);
  let gesture = "none";

  if(hands.length){
    const lm = hands[0].landmarks;
    const idx=up(lm[8],lm[6]);
    const mid=up(lm[12],lm[10]);
    const ring=up(lm[16],lm[14]);
    const pink=up(lm[20],lm[18]);

    if(idx && !mid && !ring && !pink) gesture="one";
    else if(idx && mid && !ring && !pink) gesture="two";
    else if(idx && pink && !mid && !ring) gesture="three";
    else if([idx,mid,ring,pink].filter(v=>v).length>=3) gesture="four";
    else if(dist(lm[4],lm[2])>30 && lm[8][1]>lm[6][1]) gesture="five";

    const photoOnly = !mid && !ring && !pink;
    if(dist(lm[4],lm[8])<35 && photoOnly) gesture="photo";
  }

  if(gesture===lastGesture) gestureFrames++;
  else gestureFrames=0;
  lastGesture=gesture;

  if(gestureFrames>=HOLD && Date.now()-lastSwitch>COOLDOWN){

    if(gesture==="photo"){
      mode="photo";
      currentSlide=-1;
      showPhoto();
      particles=[];
      ctx.clearRect(0,0,c.width,c.height);
    }

    else if(["one","two","three","four","five"].includes(gesture)){
      const map={one:0,two:1,three:2,four:3,five:4};
      const nextSlide = map[gesture];

      mode="slide";
      hidePhoto();

      if(currentSlide!==nextSlide){
        currentSlide=nextSlide;
        drawParticles(slides[currentSlide]);
      }
    }

    else{
      mode="idle";
      currentSlide=-1;
      hidePhoto();
      particles=[];
      ctx.clearRect(0,0,c.width,c.height);
    }

    lastSwitch=Date.now();
  }

  requestAnimationFrame(detect);
}

/* ===== INIT ===== */
(async()=>{
  await setupCamera();
  model = await handpose.load();
  detect();
  bgm.play().catch(()=>document.body.addEventListener("click",()=>bgm.play()));
})();
</script>
</body>
</html>
