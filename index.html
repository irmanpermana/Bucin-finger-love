<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Cinta Kita ðŸ’™</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  overflow:hidden;
}
canvas{position:fixed;inset:0;}
video{position:fixed;width:1px;height:1px;opacity:0;}

#photo{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%) scale(.6);
  max-width:70%;
  border-radius:20px;
  opacity:0;
  filter:blur(14px);
  transition:1s ease;
  box-shadow:0 0 80px rgba(0,150,255,.6);
}
</style>
</head>

<body>

<canvas id="c"></canvas>
<img id="photo" src="foto/IMG-20251103-WA0038.jpg">
<video id="video" autoplay muted playsinline></video>

<script>
/* BASIC */
const canvas=c=document.getElementById("c");
const ctx=c.getContext("2d");
const video=document.getElementById("video");
const photo=document.getElementById("photo");
c.width=innerWidth;c.height=innerHeight;
addEventListener("resize",()=>{c.width=innerWidth;c.height=innerHeight;});

let model,particles=[],currentSlide=-1;
let lastGesture="",gestureFrames=0,lastSwitch=0;
const HOLD=12, COOLDOWN=800; // HOLD lebih tinggi untuk stabil

/* SLIDES */
const slides=[
"Hai Sayangku ðŸ¥°",
"Aku Sayang Kamu ðŸ˜˜",
"Kamu adalah Rumah bagiku ðŸ¡",
"Aku berharap kita bisa terus bersama sampai kapanpun ðŸ«¶ðŸ»ðŸ¤—",
"Terimakasih sayang sudah menerima aku dengan segala kekuranganku ðŸ¥°"
];

/* PARTICLES TEXT */
function drawParticles(text){
  particles=[];ctx.clearRect(0,0,c.width,c.height);
  const maxW=c.width*0.8,maxH=c.height*0.6;
  let size=72,lines=[];
  while(size>18){
    ctx.font=`bold ${size}px system-ui`;
    lines=[];let line="";
    for(const w of text.split(" ")){
      let test=line+w+" ";
      if(ctx.measureText(test).width>maxW){
        lines.push(line);line=w+" ";
      }else line=test;
    }
    lines.push(line);
    if(lines.length*size*1.3<=maxH)break;
    size-=2;
  }
  ctx.font=`bold ${size}px system-ui`;
  ctx.fillStyle="#0af";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  lines.forEach((l,i)=>{
    ctx.fillText(l.trim(),c.width/2,
      c.height/2+i*size*1.3-(lines.length-1)*size*0.65);
  });
  const img=ctx.getImageData(0,0,c.width,c.height);
  ctx.clearRect(0,0,c.width,c.height);
  for(let y=0;y<img.height;y+=4){
    for(let x=0;x<img.width;x+=4){
      if(img.data[(y*img.width+x)*4+3]>0){
        particles.push({x:Math.random()*c.width,y:Math.random()*c.height,tx:x,ty:y});
      }
    }
  }
}

function animate(){
  ctx.clearRect(0,0,c.width,c.height);
  for(const p of particles){
    p.x+=(p.tx-p.x)*0.08;
    p.y+=(p.ty-p.y)*0.08;
    ctx.fillStyle="#0af";
    ctx.fillRect(p.x,p.y,1.5,1.5);
  }
  requestAnimationFrame(animate);
}
animate();

/* FOTO */
const showPhoto=()=>{photo.style.opacity=1;photo.style.transform="translate(-50%,-50%) scale(1)";photo.style.filter="blur(0)";}
const hidePhoto=()=>{photo.style.opacity=0;photo.style.transform="translate(-50%,-50%) scale(.6)";photo.style.filter="blur(14px)";}

/* CAMERA */
async function setupCamera(){
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  video.srcObject=s;
  return new Promise(r=>video.onloadedmetadata=r);
}

/* UTIL */
const up=(t,p)=>t[1]<p[1];
const distance=(a,b)=>Math.hypot(a[0]-b[0],a[1]-b[1]);

/* DETECT GESTURE TOLERAN */
async function detect(){
  const h=await model.estimateHands(video);
  if(!h.length){ requestAnimationFrame(detect); return; }

  const lm=h[0].landmarks;
  const idx=up(lm[8],lm[6]),
        mid=up(lm[12],lm[10]),
        ring=up(lm[16],lm[14]),
        pink=up(lm[20],lm[18]);

  let gesture="none";

  // ðŸ‘Œ Foto
  if(distance(lm[4],lm[8])<45){ gesture="photo"; showPhoto(); }
  else hidePhoto();

  // â˜ï¸ Slide 1
  if(idx && !mid && !ring && !pink) gesture="one";

  // âœŒï¸ Slide 2
  else if(idx && mid && (!ring || ring) && !pink) gesture="two";

  // ðŸ¤Ÿ Slide 3
  else if(idx && pink && (!mid || mid) && (!ring || ring)) gesture="three";

  // âœ‹ Slide 4 stabil: minimal 3 dari 4 jari utama
  else{
    const fingersUp=[idx, mid, ring, pink];
    const upCount = fingersUp.filter(v=>v).length;
    if(upCount>=3) gesture="four";
  }

  // ðŸ‘ Slide 5
  const thumbDist = distance(lm[4], lm[2]);
  const fingersClosed = (lm[8][1] > lm[6][1] && lm[12][1] > lm[10][1]);
  if(thumbDist>30 && fingersClosed) gesture="five";

  // Frame counting
  if(gesture===lastGesture) gestureFrames++;
  else {gestureFrames=0; lastGesture=gesture;}

  if(gestureFrames>=HOLD && Date.now()-lastSwitch>COOLDOWN){
    const map={one:0,two:1,three:2,four:3,five:4,photo:-1};
    if(map[gesture]!==undefined){
      if(gesture!=="photo") drawParticles(slides[map[gesture]]);
      currentSlide=gesture;
      lastSwitch=Date.now();
    }
  }

  requestAnimationFrame(detect);
}

/* INIT */
(async()=>{
  await setupCamera();
  model=await handpose.load();
  detect();
})();
</script>
</body>
</html>
